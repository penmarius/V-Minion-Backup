# === Print Control Macros ===
[gcode_macro CANCEL_PRINT]
description: "Cancel: safe upward lift, park X10 Y180, optional cool down"
rename_existing: CANCEL_PRINT_BASE
# Params:
#   RETRACT  -> mm (default 3)
#   LIFT     -> Z lift in mm (default 10)
#   COOLBED  -> 1 = bed off, 0 = keep bed temp (default 0)
gcode:
    {% set RETRACT  = params.RETRACT|default(3)|float %}
    {% set LIFT     = params.LIFT|default(10)|float %}
    {% set COOLBED  = params.COOLBED|default(0)|int %}

    {% set z_max    = printer.configfile.config.stepper_z.position_max|float %}
    {% set cur_z    = printer.toolhead.position.z|float %}
    {% set target_z = [cur_z + LIFT, z_max - 1.0]|min %}

    RESPOND MSG=" Cancelling print"
    M400

    RESPOND MSG=" Retract {RETRACT}mm"
    G92 E0
    G1 E-{RETRACT} F300

    {% if target_z > cur_z %}
    RESPOND MSG=" Lifting Z to { '%.2f' % target_z } mm"
      G90
      G1 Z{target_z} F600
    {% else %}
    RESPOND MSG=" Already near top Z  skipping lift"
    {% endif %}

    RESPOND MSG=" Parking at X10 Y180"
    G1 X10 Y180 F6000

    RESPOND MSG=" Cooling down (hotend off{ ' + bed off' if COOLBED==1 else '' })"
    M107
    M104 S0
    {% if COOLBED == 1 %}
      M140 S0
    {% endif %}

    RESPOND MSG=" Motors disabled"
    M84

    # Stop the job in Klipper after our moves/cooldown
    CANCEL_PRINT_BASE

    RESPOND MSG=" Cancel complete"