# === Filament Handling Macros ===
[gcode_macro UNLOAD_FILAMENT]
description: "Heat and unload filament (LGX Lite + Dragonfly BMO)"
# Params (optional):
#   TEMP       -> swap temperature (default 220)
#   RELIEF     -> small retract before pull (default 2)
#   PULL_FAST  -> fast retract length (default 25)
#   PULL_SLOW  -> slow final retract to shape tip (default 15)
#   F_FAST     -> fast retract feedrate mm/min (default 1200)
#   F_SLOW     -> slow retract feedrate mm/min (default 300)
gcode:
    {% set TEMP      = params.TEMP|default(220)|float %}
    {% set RELIEF    = params.RELIEF|default(2)|float %}
    {% set PULL_FAST = params.PULL_FAST|default(25)|float %}
    {% set PULL_SLOW = params.PULL_SLOW|default(15)|float %}
    {% set F_FAST    = params.F_FAST|default(1200)|float %}
    {% set F_SLOW    = params.F_SLOW|default(300)|float %}

    RESPOND MSG=" UNLOAD: heating to {TEMP}C"
    M109 S{TEMP}

    RESPOND MSG=" Pressure relief {RELIEF}mm"
    G92 E0
    G1 E-{RELIEF} F300

    RESPOND MSG=" Fast pull {PULL_FAST}mm"
    G1 E-{PULL_FAST} F{F_FAST}

    RESPOND MSG=" Slow pull {PULL_SLOW}mm (tip shaping)"
    G1 E-{PULL_SLOW} F{F_SLOW}

    RESPOND MSG=" Unload complete"