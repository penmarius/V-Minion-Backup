# === Filament Handling Macros ===
[gcode_macro M600]
description: "Filament change: retract 5, Z to max, park X10 Y180, hold temps, wait 3:00, purge 50, wait 1:00, retract 3  preserves E state"
gcode:
    RESPOND MSG=" M600: filament change sequence"

    # Save state (includes absolute/relative modes, feed, E position)
    SAVE_GCODE_STATE NAME=M600_STATE

    # --- 1) Retract 5 mm (relative E) ---
    M83
    RESPOND MSG=" Retracting 5mm"
    G1 E-5 F300

    # --- 2) Z to (Zmax - 1.0) if below it ---
    {% set z_max    = printer.configfile.config.stepper_z.position_max|float %}
    {% set cur_z    = printer.toolhead.position.z|float %}
    {% set target_z = z_max - 1.0 %}
    {% if target_z > cur_z + 0.01 %}
    RESPOND MSG=" Moving Z to max-safe { '%.2f' % target_z }"
      G90
      G1 Z{target_z} F600
    {% else %}
    RESPOND MSG=" Z already near top (Z={ '%.2f' % cur_z })"
    {% endif %}

    # --- 3) Park X10 Y180 at that Z ---
    RESPOND MSG=" Parking at X10 Y180"
    G1 X10 Y180 F6000

    # --- 4) Hold current hotend & bed temperatures ---
    {% set hotend_target = printer.extruder.target|float %}
    {% set bed_target    = printer.heater_bed.target|float %}
    RESPOND MSG=" Holding temps  Hotend {hotend_target}C, Bed {bed_target}C"
    M104 S{hotend_target}
    M140 S{bed_target}

    # --- 5) Wait 3 minutes (no countdown) ---
    RESPOND MSG=" Waiting 3 minutes for swap"
    M400
    G4 P180000

    # --- 6) Purge 50 mm (still relative E) ---
    RESPOND MSG=" Purging 50mm"
    G1 E50 F300
    M400

    # --- 7) Wait 1 minute (no countdown) ---
    RESPOND MSG=" Waiting 1 minute after purge"
    G4 P60000

    # --- 8) Small retract 3 mm to prevent ooze ---
    RESPOND MSG=" Retracting 3mm to prevent ooze"
    G1 E-3 F300

    # Restore the original print state (E position/modes/feed)
    RESTORE_GCODE_STATE NAME=M600_STATE

    RESPOND MSG=" M600 sequence complete  returning to print"