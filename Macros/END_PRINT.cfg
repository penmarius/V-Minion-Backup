# === Print Control Macros ===
[gcode_macro END_PRINT]
description: "Safe end: retract, lift only upward, park X10 Y180, cool down"
# Params:
#   RETRACT  -> end retract in mm (default 3)
#   LIFT     -> Z lift in mm (default 10)
#   COOLBED  -> 1 = bed off, 0 = keep current temp (default 1)
gcode:
    {% set RETRACT  = params.RETRACT|default(3)|float %}
    {% set LIFT     = params.LIFT|default(10)|float %}
    {% set COOLBED  = params.COOLBED|default(1)|int %}

    {% set z_max    = printer.configfile.config.stepper_z.position_max|float %}
    {% set cur_z    = printer.toolhead.position.z|float %}
    {% set target_z = [cur_z + LIFT, z_max - 1.0]|min %}

    RESPOND MSG=" Ending print sequence"
    M400

    RESPOND MSG=" Retract {RETRACT}mm"
    G92 E0
    G1 E-{RETRACT} F300

    {% if target_z > cur_z %}
    RESPOND MSG=" Lifting Z to { '%.2f' % target_z } mm"
      G90
      G1 Z{target_z} F600
    {% else %}
    RESPOND MSG=" Already at top Z  skipping lift"
    {% endif %}

    RESPOND MSG=" Parking at X10 Y180"
    G1 X10 Y180 F6000

    RESPOND MSG=" Cooling down"
    M107
    M104 S0
    {% if COOLBED == 1 %}
      M140 S0
    RESPOND MSG="    Hotend off + Bed off"
    {% else %}
    RESPOND MSG="    Hotend off (Bed kept warm)"
    {% endif %}

    M84
    RESPOND MSG=" Print complete"